名称: Build Armbian RK3128 armv7 (Print Server)
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Armbian build repo
        uses: actions/checkout@v4
使用:
          repository: armbian/build
引用: 主

      - 名称: 安装32位依赖
运行: sudo dpkg --add-architecture i386 && sudo apt update && sudo apt install -y libc6:i386 libncurses5:i386 libstdc++6:i386 gcc-arm-linux-gnueabihf crossbuild-essential-armhf

      - 名称: 创建userpatches目录
运行: mkdir -p userpatches/boards

      - 名称: 写入核心配置文件
: echo'ARCH=arm BOARD=rk3128 BOARD_NAME="RK3128 电视盒（armv7 32位）" KERNEL_TARGET="current" TOOLCHAIN="arm-linux-gnueabihf" RELEASE=bookworm DESKTOP="none" MINIMAL=yes EXTRA_PACKAGES="p910nd cups cups-bsd" BUILD_KSYM=no BUILD_UBOOT=yes KERNEL_CONFIG_OVERRIDE="CONFIG_USB_PRINTER=y CONFIG_USB_USBNET=y CONFIG_NETWORK_FILESYSTEMS=y CONFIG_PRINTING=y" IMAGE_TYPE=img COMPRESS_OUTPUT=yes'> userpatches/config-rk3128-armv7.conf

      - 名称: 写入自定义启动脚本
: echo'#!/bin/bash set -e systemctl enable p910nd systemctl start p910nd systemctl enable cups systemctl start cups sudo ufw allow 9100/tcp sudo ufw allow 631/tcp echo "P910ND_OPTS=\"-f /dev/usb/lp0\"" > /etc/default/p910nd sed -i "s/Listen localhost:631/Port 631/" /etc/cups/cupsd.conf sed -i "s/<Location \/>/<Location \/>  Allow all/" /etc/cups/cupsd.conf'> userpatches/customize-image.sh

      - 名称: 赋予脚本执行权限


      - 名称: 写入设备树配置
: echo'LINUXFAMILY=rockchip KERNEL_IMAGE_TYPE=zImage KERNEL_ADDR=0x60408000 KERNEL_DEVICETREE="rk3128-box.dtb" UBOOT_TARGET=rk3128-box UBOOT_CONFIG=rk3128-box_defconfig'> userpatches/boards/rk3128.conf

      - 名称: 编译Armbian（强制32位）
: ./compile.sh BOARD=rk3128 ARCH=arm RELEASE=bookworm BUILD_MINIMAL=yes EXTRA_PACKAGES="p910nd cups"KERNEL_TARGET=current

      - 名称: 上传固件
使用: actions/upload-artifact@v4
使用:
          name: armbian-rk3128-armv7-print-server
路径: output/images/*.img.xz
