name: Build Armbian RK3128 armv7 (Print Server)
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Armbian build repo
        uses: actions/checkout@v4
        with:
          repository: armbian/build
          ref: main

      - name: 安装基础依赖
        run: sudo apt update && sudo apt install -y git curl wget build-essential libncurses5-dev libssl-dev flex bison bc kmod cpio rsync unzip qemu-user-static

      - name: 创建非交互配置文件（核心）
        run: mkdir -p userpatches && echo 'BOARD="rk3128"\nARCH="arm"\nRELEASE="bullseye"\nBUILD_MINIMAL="yes"\nBUILD_DESKTOP="no"\nKERNEL_TARGET="legacy"\nEXTRA_PACKAGES="p910nd cups cups-bsd"\nNONINTERACTIVE="yes"\nBUILD_CONFIGURE="no"\nSKIP_CONFIG="yes"\nSKIP_GIT="yes"\nSKIP_BOOTSPLASH="yes"\nSKIP_KERNEL_CLEAN="yes"\nKERNEL_CONFIGURE="no"\nIMAGE_TYPE="img"\nCOMPRESS_OUTPUT="yes"\nUBOOT_TARGET="rk3128-box"\nKERNEL_DEVICETREE="rk3128-box.dtb"\nTOOLCHAIN="arm-linux-gnueabihf"' > userpatches/config-custom.conf

      - name: 创建内核配置
        run: echo 'CONFIG_ARM=y\nCONFIG_ARCH_ROCKCHIP=y\nCONFIG_ARCH_RK3128=y\nCONFIG_USB_PRINTER=y\nCONFIG_USB_USBNET=y\nCONFIG_NETWORK_FILESYSTEMS=y\nCONFIG_PRINTING=y\nCONFIG_SERIAL_DEV=y\nCONFIG_VFAT_FS=y\nCONFIG_EXT4_FS=y\nCONFIG_MMC_BLOCK=y\nCONFIG_SPI_FLASH=y\nCONFIG_USB_STORAGE=y' > userpatches/kernel-config-rk3128

      - name: 创建自定义脚本
        run: echo '#!/bin/bash\nsystemctl enable p910nd && systemctl start p910nd\nsystemctl enable cups && systemctl start cups\necho "P910ND_OPTS=\"-f /dev/usb/lp0\"" > /etc/default/p910nd\nsed -i "s/Listen localhost:631/Port 631/" /etc/cups/cupsd.conf\nsed -i "/<Location \/>/a Allow all" /etc/cups/cupsd.conf\nsudo ufw allow 9100/tcp && sudo ufw allow 631/tcp' > userpatches/customize-image.sh && chmod +x userpatches/customize-image.sh

      - name: 非交互编译（Armbian原生方式）
        run: sudo ./compile.sh CONFIG=custom.conf NONINTERACTIVE=yes BUILD_MINIMAL=yes KERNEL_CONFIGURE=no SKIP_CONFIG=yes SKIP_GIT=yes 2>&1 | tee build.log

      - name: 提前创建输出目录
        run: mkdir -p ${{ github.workspace }}/output && sudo cp -r output/images/ ${{ github.workspace }}/output/ || true && sudo cp build.log ${{ github.workspace }}/output/ || true

      - name: 上传固件和日志
        uses: actions/upload-artifact@v4
        with:
          name: armbian-rk3128-print-server
          path: |
            ${{ github.workspace }}/output/**/*.img
            ${{ github.workspace }}/output/**/*.img.xz
            ${{ github.workspace }}/output/build.log

      - name: 清理临时文件
        run: sudo rm -rf .tmp output/debs output/logs || true
