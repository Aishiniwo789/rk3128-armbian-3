name: Build RK3128 OpenWrt Print Server
on:
  push:
    branches: [ main ]
  workflow_dispatch: # 手动触发编译

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 环境准备
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt update && sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget
          sudo apt autoremove -y && sudo apt clean -y

      - name: 拉取适配 RK3128 的 OpenWrt 源码（lean 版，稳定）
        run: git clone --depth 1 --branch openwrt-19.07 https://github.com/coolsnowwolf/lede.git openwrt && cd openwrt

      - name: 添加 RK3128 设备配置（核心适配）
        run: |
          cd openwrt
          # 添加 RK3128 盒子通用配置
          echo -e 'CONFIG_TARGET_rockchip=y\nCONFIG_TARGET_rockchip_armv7=y\nCONFIG_TARGET_rockchip_armv7_DEVICE_rk3128-box=y' >> .config
          # 集成打印服务组件（p910nd + CUPS）
          echo -e 'CONFIG_PACKAGE_p910nd=y\nCONFIG_PACKAGE_cups=y\nCONFIG_PACKAGE_cups-bsd=y\nCONFIG_PACKAGE_usbutils=y\nCONFIG_PACKAGE_ufw=y' >> .config
          # 基础组件（网络/USB）
          echo -e 'CONFIG_PACKAGE_usb-printer=y\nCONFIG_PACKAGE_kmod-usb-printer=y\nCONFIG_PACKAGE_kmod-usb-storage=y\nCONFIG_PACKAGE_samba4-server=y' >> .config
          # 精简固件（移除冗余组件）
          echo -e 'CONFIG_PACKAGE_luci-theme-argon=n\nCONFIG_PACKAGE_luci-app-ddns=n\nCONFIG_PACKAGE_luci-app-v2ray=n' >> .config

      - name: 下载依赖包
        run: cd openwrt && ./scripts/feeds update -a && ./scripts/feeds install -a

      - name: 开始编译固件
        run: |
          cd openwrt
          make defconfig
          make -j$(nproc) download V=s
          make -j$(nproc) V=s 2>&1 | tee build.log

      - name: 收集固件
        run: |
          mkdir -p ${{ github.workspace }}/firmware
          cp openwrt/bin/targets/rockchip/armv7/*.img.gz ${{ github.workspace }}/firmware/ || true
          cp openwrt/build.log ${{ github.workspace }}/firmware/ || true

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: RK3128-OpenWrt-Print-Server
          path: ${{ github.workspace }}/firmware/*
