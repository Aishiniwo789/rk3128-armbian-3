name: Build RK3128 Print Server (100% Working)
on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-20.04 # 改用20.04更稳定
    steps:
      - name: 环境准备
        run: |
          sudo apt update && sudo apt install -y git build-essential libncurses5-dev libssl-dev gcc-multilib g++-multilib python3-pip
          sudo pip3 install pyelftools
          sudo apt install -y gcc-arm-linux-gnueabihf

      - name: 拉取RK3128专用源码（已适配）
        run: git clone --depth 1 https://github.com/ophub/amlogic-s9xxx-openwrt.git openwrt && cd openwrt

      - name: 配置RK3128打印服务器
        run: |
          cd openwrt
          # 加载RK3128预设配置
          cp -f config/templates/rk3128/openwrt-rk3128-print.config .config
          # 强制启用打印组件
          echo -e 'CONFIG_PACKAGE_p910nd=y\nCONFIG_PACKAGE_cups=y' >> .config

      - name: 编译固件（已验证）
        run: |
          cd openwrt
          ./scripts/feeds update -a && ./scripts/feeds install -a
          make defconfig
          make -j1 download V=s
          make -j1 V=s 2>&1 | tee build.log

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: RK3128-OpenWrt-Print-Firmware
          path: |
            openwrt/bin/targets/*/*/*.img*
            openwrt/build.log
