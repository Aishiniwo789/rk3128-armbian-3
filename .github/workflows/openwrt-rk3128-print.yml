name: Build RK3128 OpenWrt Print Server
on:
  push:
    branches: [ main ]
  workflow_dispatch: # 手动触发编译

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 环境准备
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt update && sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget
          sudo apt autoremove -y && sudo apt clean -y

      - name: 拉取适配 RK3128 的 OpenWrt 源码（修正分支）
        run: git clone --depth 1 https://github.com/coolsnowwolf/lede.git openwrt && cd openwrt

      - name: 手动添加 RK3128 设备树（核心适配）
        run: |
          cd openwrt
          # 下载 RK3128 通用设备树文件
          mkdir -p target/linux/rockchip/armv7/base-files/lib/firmware/rockchip
          wget -O target/linux/rockchip/armv7/base-files/lib/firmware/rockchip/rk3128-box.dtb https://raw.githubusercontent.com/rockchip-linux/kernel/rockchip-rk3128-linux-4.4/arch/arm/boot/dts/rk3128-box.dtb
          # 配置 RK3128 编译参数
          echo -e 'CONFIG_TARGET_rockchip=y\nCONFIG_TARGET_rockchip_armv7=y\nCONFIG_TARGET_MULTI_PROFILE=y\nCONFIG_TARGET_DEVICE_rockchip_armv7_DEVICE_rk3128-box=y' > .config
          # 集成打印服务组件（p910nd + CUPS）
          echo -e 'CONFIG_PACKAGE_p910nd=y\nCONFIG_PACKAGE_cups=y\nCONFIG_PACKAGE_cups-bsd=y\nCONFIG_PACKAGE_usbutils=y\nCONFIG_PACKAGE_ufw=y' >> .config
          # 基础驱动组件
          echo -e 'CONFIG_PACKAGE_usb-printer=y\nCONFIG_PACKAGE_kmod-usb-printer=y\nCONFIG_PACKAGE_kmod-usb-storage=y\nCONFIG_PACKAGE_samba4-server=y\nCONFIG_PACKAGE_kmod-nls-utf8=y' >> .config
          # 精简固件（移除冗余）
          echo -e 'CONFIG_PACKAGE_luci-theme-argon=n\nCONFIG_PACKAGE_luci-app-ddns=n\nCONFIG_PACKAGE_luci-app-v2ray=n\nCONFIG_PACKAGE_luci-app-passwall=n' >> .config

      - name: 下载依赖包
        run: cd openwrt && ./scripts/feeds update -a && ./scripts/feeds install -a

      - name: 修复依赖缺失（RK3128 适配）
        run: |
          cd openwrt
          # 安装 rockchip 专用依赖
          ./scripts/feeds install -p custom rockchip-base
          # 生成默认配置
          make defconfig

      - name: 开始编译固件
        run: |
          cd openwrt
          make -j$(nproc) download V=s
          make -j$(nproc) V=s 2>&1 | tee build.log

      - name: 收集固件
        run: |
          mkdir -p ${{ github.workspace }}/firmware
          cp openwrt/bin/targets/rockchip/armv7/*.img.gz ${{ github.workspace }}/firmware/ || true
          cp openwrt/bin/targets/rockchip/armv7/*.img ${{ github.workspace }}/firmware/ || true
          cp openwrt/build.log ${{ github.workspace }}/firmware/ || true

      - name: 上传固件
        uses: actions/upload-artifact@v4
        with:
          name: RK3128-OpenWrt-Print-Server
          path: ${{ github.workspace }}/firmware/*
