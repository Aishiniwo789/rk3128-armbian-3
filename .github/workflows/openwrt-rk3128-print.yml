name: Build RK3128 OpenWrt Print Server (32bit ARMv7)
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: 环境准备（补全所有依赖）
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc
          sudo apt update && sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget python3-pip
          # 安装缺失的 Python 依赖（解决 elftools 错误）
          sudo pip3 install pyelftools pycryptodome
          sudo apt autoremove -y && sudo apt clean -y

      - name: 拉取 OpenWrt 源码（32位 ARM 适配版）
        run: git clone --depth 1 https://github.com/coolsnowwolf/lede.git openwrt && cd openwrt

      - name: 强制指定 32 位 ARMv7 编译（核心修复）
        run: |
          cd openwrt
          # 清空默认配置，强制 32 位 ARMv7 + rockchip
          echo -e 'CONFIG_TARGET_rockchip=y\nCONFIG_TARGET_rockchip_armv7=y\nCONFIG_TARGET_rockchip_armv7_DEVICE_generic=y\nCONFIG_TARGET_BOARD="rockchip"\nCONFIG_TARGET_SUBTARGET="armv7"\nCONFIG_TARGET_ARCH_PACKAGES="arm_cortex-a17_neon-vfpv4"\nCONFIG_CPU_TYPE="cortex-a17"\nCONFIG_ARM64=n\nCONFIG_aarch64=n' > .config
          # 集成打印服务（仅保留核心功能）
          echo -e 'CONFIG_PACKAGE_p910nd=y\nCONFIG_PACKAGE_cups=y\nCONFIG_PACKAGE_cups-bsd=y\nCONFIG_PACKAGE_usbutils=y\nCONFIG_PACKAGE_kmod-usb-printer=y\nCONFIG_PACKAGE_kmod-usb-storage=y' >> .config
          # 跳过故障的 uboot 编译（关键）
          echo -e 'CONFIG_PACKAGE_uboot-rockchip=n\nCONFIG_PACKAGE_uboot-tools=n' >> .config
          # 精简配置，减少编译错误
          echo -e 'CONFIG_PACKAGE_luci=n\nCONFIG_PACKAGE_ppp=n\nCONFIG_PACKAGE_ip6tables=n\nCONFIG_PACKAGE_odhcp6c=n' >> .config

      - name: 更新依赖并修复架构
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          # 强制设置编译架构为 32 位
          sed -i 's/TARGET_ARCH:=aarch64/TARGET_ARCH:=arm/g' target/linux/rockchip/Makefile
          sed -i 's/SUBTARGET:=aarch64/SUBTARGET:=armv7/g' target/linux/rockchip/Makefile

      - name: 生成配置并下载依赖
        run: |
          cd openwrt
          make defconfig
          make -j$(nproc) download V=s

      - name: 编译固件（单线程 + 跳过 uboot）
        run: |
          cd openwrt
          # 单线程编译 32 位固件，避免多核错误
          make -j1 IGNORE_ERRORS=1 V=s 2>&1 | tee build.log

      - name: 收集所有可能的固件文件
        run: |
          mkdir -p ${{ github.workspace }}/firmware
          # 复制 32 位 ARMv7 固件（兼容 RK3128）
          cp openwrt/bin/targets/rockchip/armv7/*.img* ${{ github.workspace }}/firmware/ || true
          cp openwrt/bin/targets/rockchip/armv7/*.bin ${{ github.workspace }}/firmware/ || true
          cp openwrt/build.log ${{ github.workspace }}/firmware/ || true

      - name: 上传固件和日志
        uses: actions/upload-artifact@v4
        with:
          name: RK3128-OpenWrt-ARMv7-Print-Server
          path: ${{ github.workspace }}/firmware/*
